<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Recipe Book</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-4bw+/aepP/YC94hEpVNVgiZdgIC5+VKNBQNGCHeKRQN+PtmoHDEXuppvnDJzQIu9" crossorigin="anonymous">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background-color: #f8f9fa;
        }
        .card {
            border: none;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .card-img-top {
            border-radius: 10px 10px 0 0;
            height: 200px;
            object-fit: cover;
        }
        .card:hover {
            box-shadow: 0 6px 8px rgba(0,0,0,0.15);
        }
        .card-body {
            padding: 15px;
        }
        .card-title {
            color: #333;
            font-size: 1.2rem;
            margin-bottom: 5px;
        }
        .card-text {
            color: #555;
            font-size: 1rem;
        }
        .image-container {
            position: relative;
        }
        .refresh-icon {
            font-size: 30px;
        }
        .delete-icon {
            font-size: 1.3em; /* Size of the icon */
            color: #dc3545; /* Color of the icon */
            top: 0.25em; /* Distance from the top edge */
            right: 0.25em; /* Distance from the right edge */
            padding: 0.25em; /* Space around the icon */
        }

        .bi-x-circle-fill {
            /* Icon styling */
            color: inherit; /* Inherits the color from .delete-icon */
            border-radius: 50%; /* Optional: rounded circle around the icon */
            padding: 0.25em; /* Padding inside the circle */
        }
        .delete-icon.hidden {
            display: none;
        }
        /* Make sure to include the Bootstrap Icons stylesheet */
        .custom-switch .form-check-input {
            width: 4em !important; /* Increase the width of the switch */
            height: 2em !important; /* Adjust the height to maintain aspect ratio */
            cursor: pointer;
            margin-bottom: 5px;
        }

        .custom-switch .form-check-input:checked {
            background-color: #198754 !important; /* Bootstrap green color */
            border-color: #198754 !important; /* Bootstrap green color */
        }

        .custom-switch .form-check-input:checked::after {
            transform: translateX(1.5em) !important; /* Adjust this value based on the width of the switch */
        }
        .search-bar {
            margin: 20px 0;
        }
    </style>
</head>
<body>

<div class="container mt-3">
    <h2>Recipe Book</h2>

    <div class="search-bar">
        <input class="form-control" type="search" placeholder="Search" aria-label="Search">
    </div>

    <div class="d-flex justify-content-end custom-switch align-items-center">
        <button id="initializeButton" class="btn btn-danger p-2 me-2 mb-1" type="button">초기화</button>
        <button id="refreshButton" class="btn btn-link p-0 me-2 refresh-icon" type="button">
            <i class="bi bi-arrow-clockwise"></i>
        </button>
        <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" role="switch" id="toggleIconSwitch" checked
                   title="삭제기능 on/off" data-bs-toggle="tooltip">
            <label class="form-check-label" for="toggleIconSwitch"></label>
        </div>
    </div>

    <div class="row">
        <div class="col-md-4" th:each="item : ${items}" th:id="'video-' + ${item.videoId}">
            <a th:href="@{'/detail/' + ${item.videoId}}" class="card-link">
                <div class="card">
                    <!-- Image container with relative positioning -->
                    <div class="image-container position-relative">
                        <img th:src="@{${item.thumbnailUrl}}" class="card-img-top" alt="Recipe Image">
                        <!-- Absolutely positioned 'x' icon inside the container -->
                        <a href="#" class="delete-icon position-absolute top-0 end-0" th:data-video-id="${item.videoId}">
                            <span class="delete-icon position-absolute top-0 end-0 bi bi-x-circle-fill hidden"></span>
                        </a>
                    </div>
                    <div class="card-body">
                        <h5 class="card-title" th:text="${item.title}">Recipe Title</h5>
                        <!-- Description is commented out -->
                    </div>
                </div>
            </a>
        </div>
    </div>

</div>
<script>
    document.addEventListener('DOMContentLoaded', (event) => {
        let currentPage = parseInt(sessionStorage.getItem("currentPage")) || 1; // 세션에 값을 가져오거나 없으면 1
        const pageSize = window.innerWidth <= 768 ? 10 : 5; // 모바일은 10, PC는 30
        let isFetching = false; // 현재 데이터를 가져오고 있는지 상태를 표시
        let isEndOfData = false; // 데이터가 더 이상 없는지 상태를 표시

        window.addEventListener('scroll', () => {
            const { scrollTop, scrollHeight, clientHeight } = document.documentElement;
            if (scrollTop + clientHeight >= scrollHeight - 5) { // 스크롤이 페이지 하단에 거의 도달했는지 확인
                fetchPlaylist();    // 추가 데이터 요청
            }
        });

        window.addEventListener('popstate', event => {
            if (event.state && event.state.page) {
                currentPage = event.state.page;
            }
        })

        function fetchPlaylist() {
            if (isFetching || isEndOfData) return;

            isFetching = true;
            fetch(`/playlists?page=${currentPage}`)
                .then(response => response.json())
                .then(data => {
                    if (data.length < pageSize) {
                        isEndOfData = true; // 받아온 데이터 수가 pageSize보다 작으면 더 이상 데이터가 없는 것으로 간주
                    }
                    sessionStorage.setItem("currentPage", currentPage.toString());  // 현재 페이지 넘버 저장
                    if (!isEndOfData) {
                        history.pushState({ page: currentPage }, '', `/?page=${currentPage}`);
                        currentPage += 1;   // 더 받아올 데이터가 있다면 페이지 번호 증가
                    }
                    appendPlaylists(data); // DOM에 받아온 데이터 추가
                    isFetching = false;
                    console.log(currentPage);
                })
                .catch(error => {
                    console.error('Error fetching playlists:', error);
                    isFetching = false;
                });
        }

        function appendPlaylists(playlists) {
            const row = document.querySelector('.row');
            playlists.forEach(playlist => {
                const col = document.createElement('div');
                col.className = 'col-md-4';
                col.id = 'video-' + playlist.videoId;

                const cardLink = document.createElement('a');
                cardLink.href = '/detail/' + playlist.videoId;
                cardLink.className = 'card-link';

                const card = document.createElement('div');
                card.className = 'card';

                const imageContainer = document.createElement('div');
                imageContainer.className = 'image-container position-relative';

                const img = document.createElement('img');
                img.src = playlist.thumbnailUrl;
                img.className = 'card-img-top';
                img.alt = 'Recipe Image';

                const deleteIconLink = document.createElement('a');
                deleteIconLink.href = '#';
                deleteIconLink.className = 'delete-icon position-absolute top-0 end-0';
                deleteIconLink.dataset.videoId = playlist.videoId;  // Custom data attribute to store the video ID

                const deleteIcon = document.createElement('span');
                deleteIcon.className = 'delete-icon position-absolute top-0 end-0 bi bi-x-circle-fill hidden';

                const cardBody = document.createElement('div');
                cardBody.className = 'card-body';

                const cardTitle = document.createElement('h5');
                cardTitle.className = 'card-title';
                cardTitle.textContent = playlist.title;

                // Construct the elements hierarchy
                deleteIconLink.appendChild(deleteIcon);
                imageContainer.appendChild(img);
                imageContainer.appendChild(deleteIconLink);
                card.appendChild(imageContainer);
                cardBody.appendChild(cardTitle);
                card.appendChild(cardBody);
                cardLink.appendChild(card);
                col.appendChild(cardLink);
                row.appendChild(col);
            });
        }


        const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        const tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });

        const initializeButton = document.getElementById('initializeButton');
        const refreshButton = document.getElementById('refreshButton');

        initializeButton.addEventListener('click', function() {
            // Display a confirmation dialog
            if (confirm('정말로 초기화하시겠습니까?')) {
                // Proceed with the fetch request if the user confirmed
                fetch('/initialize/video', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        // 필요한 경우 CSRF 토큰 포함
                    }
                })
                    .then(response => {
                        if (!response.ok) {
                            // If the server response is not OK, throw an error
                            throw new Error('서버에 문제가 발생했습니다!');
                        }
                        return response.json(); // Parse the response as JSON
                    })
                    .then(data => {
                        alert(data.message); // Alert the user with the message from the response
                        window.location.reload(); // Reload the page after successful reset
                    })
                    .catch(error => {
                        console.error('재생 목록 초기화 중 오류 발생:', error); // Log any errors to the console
                    });
            } else {
                // If the user cancels, you might want to do something here or simply do nothing
                console.log('초기화가 취소되었습니다.');
            }
        });

        refreshButton.addEventListener('click', function() {
            // Display a confirmation dialog
            if (confirm('새로고침하시겠습니까?')) {
                // Proceed with the fetch request if the user confirmed
                fetch('/refresh/video', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        // 필요한 경우 CSRF 토큰 포함
                    }
                })
                    .then(response => {
                        if (!response.ok) {
                            // If the server response is not OK, throw an error
                            throw new Error('서버에 문제가 발생했습니다!');
                        }
                        return response.json(); // Parse the response as JSON
                    })
                    .then(data => {
                        alert(data.message); // Alert the user with the message from the response
                        window.location.reload(); // Reload the page after successful refresh
                    })
                    .catch(error => {
                        console.error('재생목록 새로고침 중 오류 발생:', error); // Log any errors to the console
                    });
            } else {
                // If the user cancels, you might want to do something here or simply do nothing
                console.log('새로고침이 취소되었습니다.');
            }
        });

        document.querySelectorAll('a.delete-icon').forEach(function (element) {
            element.addEventListener('click', function (event) {
                // Prevent the default anchor behavior and stop event propagation
                event.preventDefault();
                event.stopPropagation(); // Add this line
                const videoId = this.getAttribute('data-video-id');
                deleteVideo(event, videoId);
            });
        });

        // Get the switch and the delete icons
        const storedState = localStorage.getItem('switchState');
        const toggle = document.getElementById('toggleIconSwitch');
        const deleteIcons = document.querySelectorAll('.delete-icon');

        if (storedState === 'on') {
            toggle.checked = true;
            deleteIcons.forEach(icon => icon.classList.remove('hidden'));
        } else {
            toggle.checked = false;
            deleteIcons.forEach(icon => icon.classList.add('hidden'));
        }

        // Define the toggle function
        function toggleIcons() {
            deleteIcons.forEach(icon => {
                if (toggle.checked) {
                    icon.classList.remove('hidden');
                    localStorage.setItem('switchState', 'on');
                } else {
                    icon.classList.add('hidden');
                    localStorage.setItem('switchState', 'off');
                }
            });
        }

        // Attach the event listener to the switch
        toggle.addEventListener('change', toggleIcons);

        // Call the function on page load to set the initial state
        toggleIcons();
    });

    function deleteVideo(event, videoId) {
        event.preventDefault(); // Prevent the default anchor behavior

        if (confirm('Are you sure you want to delete this video?')) {
            fetch('/delete/video/' + videoId, {
                method: 'DELETE',
                // Add any needed headers, credentials, etc.
                headers: {
                    'Content-Type': 'application/json',
                    // If you're using CSRF protection, you'll need to include your CSRF token here
                },
                // If you need credentials such as cookies, include them in the request
                credentials: 'include'
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    // Assume response is OK; proceed to remove the item from the DOM
                    const itemElement = document.getElementById('video-' + videoId);
                    if (itemElement) {
                        itemElement.remove(); // Remove the item's container from the DOM
                    }
                    return response.json(); // or response.text() if your server sends a non-JSON response
                })
                .then(data => {
                    console.log(data);
                    // Here you can handle redirection after deletion,
                    // Or remove the element from the DOM to reflect the change immediately.
                })
                .catch(error => {
                    console.error('There was an error deleting the video:', error);
                });
        }
    }
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-HwwvtgBNo3bZJJLYd8oVXjrBZt8cqVSpeBNS5n7C8IVInixGAoxmnlMuBnhbgrkm" crossorigin="anonymous"></script>
</body>
</html>